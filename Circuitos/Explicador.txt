Estou usando o STM 32 Cube. O sistema captura através do ADC os dados, como dados de engenharia. E armazena no SD. É necessário aplicar filtro passa-baixa. E se o usb não receber os dados de calibração ele usa o mocado para o calculo, se o USB receber os dados de calibração para o cálculo dos dados de engenharia substitui pelos dados mocados.

O meu sistema ta dividido em adc_sensor.h, filter.h, rtc_utils.h, sd_logger.h e usb_common.h.